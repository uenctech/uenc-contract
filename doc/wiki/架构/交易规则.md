---
sidebar_position: 4
---
UENC链上出块是被动行为，只有交易产生时才会产生区块，而并非定时出块机制。
### 交易流程
交易之前请先确定自己的节点高度和全网区块高度是否相差在10个之内。

1. 客户端通过`create_tx_message`接口向节点发起交易请求，包括`from_addr`，`to_addr`和`fee`等信息，节点创建交易体数据，客户端获得`tx_data`和`tx_encode_hash`信息。

2. 客户端通过调用本地动态签名库的`GenSign_`方法，通过本地调用对`tx_encode_hash`进行签名。或者通过`generate_sign`接口向节点发送私钥和 `tx_encode_hash` 信息，节点对`tx_encode_hash`信息进行签名，客户端获得签名信息`tx_signature`。后者方法由于涉及到私钥不建议使用，如使用必须保证发送节点的可靠性。

3. 客户端通过`send_tx`接口 将`tx_data`，`public_key`，`tx_encode_hash`和`tx_signature`发送到节点，该交易通过节点发送到全网进行签名验证，客户端得到该交易的`tx_hash`。客户端将`tx_hash`信息留存，待交易确认时查询用。

4. 客户端可用`get_pending_transaction`接口向节点发送地址信息，获得当前地址发起的已挂起的交易哈希，判断是否和第4步留存的`tx_hash`一致来判断该交易是否在进行中，若交易进行中将无法使用相同的账号再次发起交易，需等待交易上链，确定交易最终状态后可再次进行交易。

投票签名服务由 JSON-RPC 服务器和请求处理器组成。 启动时，服务会在配置端口启动RPC服务器，等待验证节点请求。

### 交易规则

如A节点发送交易将进入双验证池，处于数据最佳可用状态下的公网节点将随机进行该笔交易的第一次验证检查，随后进入验证节点的随机验证池内,进行交易体的签名验证，完成局部共识确定合法性后将由发起节点建块并向全网广播，其他节点验证合法性后全网完成共识。

在进行交易的时候，我们限制了UTXO的最大调用数量为100个，UTXO通过固定的算法调用，当小额的UTXO不满足交易数量时，我们就会拆分大额的UTXO。这样的目的是既能满足交易时的UTXO数额，又可以把部分零碎的UTXO消耗掉。也能保证交易的成功率和效率。

### 签名服务

在整个交易流程中，涉及到客户端的签名和服务端的签名。客户端在进行交易发起的第一步后对拿到的验证hash进行签名发送到节点进行验证。这里的验证需要调用静态库文件进行签名。具体使用方法详见调用静态库。

服务端的签名是在验证池里进行选举签名节点后进行的区块签名，此签名完全按照四分位算法屏蔽掉异常非法获取收益的节点后进行签名，采用椭圆曲线数字签名算法（ECDSA）对交易进行签名打包，保证签名合法性和随机性。
### 交易机制
当某个交易达到全网60%以上的节点确认并建块时，则视为该交易成功上链。在某些情况下，比如网络延迟或是产生双花行为，交易仅在全网部分节点（不足60%）建块，则该交易区块在同步算法中进行纠错，如果存在双花行为该笔交易会被全网放弃。

确认交易状态将通过标准接口进行判断，接口判断规则是当发起交易1分钟后，随机获取全网100个节点，向100个节点请求查询某笔交易是否在该节点上建块上链，若返回的多个节点信息中有超过60%的节点已建块，则可判断该交易已上链。若5分钟后仍未返回上述信息，可确认交易失败。
### 生成分叉
UENC的分叉指在区块链中有两个或多个使用相同utxo的同一账户发出的交易并存的情况。在后续交易中生成的区块必须依赖之前生成的区块和交易，因此后续块有多个不同前置区块可以选择形成单独的链。

一般这种情况发生时有两种可能：
 1. 由于网络不畅，某账户新建的交易未能广播至全网时再次使用相同UTXO发起交易并建立区块后会造成分叉。
 2. 某账户在多个节点上同时发起交易，并由不同的广播路径进行建块广播造成。
### 管理分叉
当交易体创建后通过共识层时，将会由随机产生的数据状态最佳的公网节点进行交易验证，我们认为上述所发生第一种情况从第一次使用UTXO后，使用第二次时会被最佳状态数据的可用公网节点判断出来，从而主动放弃交易流转，避免双花。如果发生第二种情况交易体将会同时进入blockpool在预生长高度期中被检查后抛弃，无法完成共识，从而避免双花行为发生。

如果在某种特殊情况下仍然出现分叉，需要第一时间解决分叉问题。UENC在同步算法中建立了循环检查机制通过拜占庭容错算法(Practical Byzantine Fault Tolerance)对节点数据进行漏块检查和错块检查。某节点发现漏块或错块时会利用上述机制进行补块或摘块操作。
### 转账手续费
UENC交易手续费分为打包费、签名费，发起交易的节点将全额收取字节打包费用，参与验算签名的节点分配验算签名费。打包费与签名gas由节点自行在现有版本的共识区间0.001到0.1中进行设置，这是节点与用户的议价行为，如果大量节点的议价行为区间在`0.001-0.005`，
那么大量用户交易将优先采纳此区间的节点，如果此区间节点数量不足导致交易无法流转，用户必须提高交易gas。

验签签名费分为**公网节点的签名费**和**验证节点的签名费**。公网节点会进行交易的第一次签名，签名完成之后由验证节点参与流转签名。该公网节点不再参与此次的流转签名。全网交易的首次验证签名将由最佳数据状态的公网节点参与，交易体量的持续上升会给公网节点提供运维补贴，同时公网节点与验证节点享有同等的区块奖励机会，这里需要注意的是交易流转过程中任何节点都无法参与两次签名，这将视为非法签名。

在验算签名时，根据DPOW共识算法，所有主网中的节点随机获得签名机会。当每次交易产生时，会根据用户对交易的安全性需求选择验算签名的节点数量。
